import View from"./view.mjs";import sessions from"../../sessions.mjs";export default class LicenseView extends View{route="/license";_template="license";_methods=["get","post"];async handleGet(e,s){try{this.constructor.assertDocumentDestination(e)}catch(e){return s.status(401).send(e.message)}const t=global.config.license;if(!t.needsSignature)return s.redirect("/");const n=t.license?"eula":"key";return this.#e(e,s,n)}async handlePost(e,s){const{config:t}=global,n=t.license;if(!n.needsSignature)return s.redirect("/");let r=n.license?"eula":"key";if("key"===r)try{n.applyLicense(e.body.licenseKey),sessions.setMessage(e,s,"info","License key entered, please sign the End User License Agreement."),r="eula"}catch(t){sessions.setMessage(e,s,"error",t.message)}else{"decline"in e.body&&(n.applyLicense(null),t.app?t.app.quit():process.exit());const r=await n.sign();if("success"===r.status)return sessions.setMessage(e,s,"info",r.message),s.redirect(`${e.baseUrl}/setup`);if("error"===r.status)return sessions.setMessage(e,s,"error",r.message),n.applyLicense(null),s.redirect(`${e.baseUrl}/license`)}return this.#e(e,s,r)}#e(e,s,t){const n=View._getStaticContent({setup:!0});return s.render(this._template,{layout:"setup",bodyClass:"auth flexcol theme-dark",scripts:n.scripts,styles:n.styles,isEULA:"eula"===t,licenseKey:e.body.licenseKey,messages:sessions.getMessages(e,{clear:!1}),step:t})}}