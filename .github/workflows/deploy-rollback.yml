name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      backup_timestamp:
        description: "Backup timestamp to restore (format: YYYYMMDD-HHMMSS) - leave empty to list available backups"
        required: false
        type: string

jobs:
  list-backups:
    if: ${{ github.event.inputs.backup_timestamp == '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ORACLE_SSH_PRIVATE_KEY }}" > ~/.ssh/oracle_key
          chmod 600 ~/.ssh/oracle_key
          ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts

      - name: List available backups
        run: |
          ssh -i ~/.ssh/oracle_key ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'EOF'
            echo "ðŸ“‹ Available backups:"
            if [ -d "/opt/foundryvtt/backups" ]; then
              sudo ls -lh /opt/foundryvtt/backups/data-backup-*.tar.gz 2>/dev/null || echo "âŒ No backups found"
            else
              echo "âŒ Backup directory does not exist"
            fi
            echo ""
            echo "â„¹ï¸  To restore a backup, re-run this workflow with the timestamp"
            echo "   Example: 20241016-143022"
          EOF

  rollback:
    if: ${{ github.event.inputs.backup_timestamp != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ORACLE_SSH_PRIVATE_KEY }}" > ~/.ssh/oracle_key
          chmod 600 ~/.ssh/oracle_key
          ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts

      - name: Verify backup exists
        run: |
          ssh -i ~/.ssh/oracle_key ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'EOF'
            set -e
            BACKUP_FILE="/opt/foundryvtt/backups/data-backup-${{ github.event.inputs.backup_timestamp }}.tar.gz"
            
            if [ ! -f "$BACKUP_FILE" ]; then
              echo "âŒ Backup file not found: $BACKUP_FILE"
              echo "ðŸ“‹ Available backups:"
              sudo ls -lh /opt/foundryvtt/backups/data-backup-*.tar.gz 2>/dev/null || echo "No backups found"
              exit 1
            fi
            
            echo "âœ… Backup file found: $BACKUP_FILE"
          EOF

      - name: Stop FoundryVTT service
        run: |
          ssh -i ~/.ssh/oracle_key ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'EOF'
            set -e
            echo "â¸ï¸  Stopping FoundryVTT service..."
            sudo systemctl stop foundryvtt
            echo "âœ… Service stopped"
          EOF

      - name: Backup current data before rollback
        run: |
          ssh -i ~/.ssh/oracle_key ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'EOF'
            set -e
            echo "ðŸ’¾ Creating backup of current data before rollback..."
            BACKUP_FILE="data-before-rollback-$(date +%Y%m%d-%H%M%S).tar.gz"
            
            if [ -d "/opt/foundryvtt/data" ]; then
              sudo tar -czf "/opt/foundryvtt/backups/$BACKUP_FILE" -C /opt/foundryvtt data/
              echo "âœ… Current data backed up as: $BACKUP_FILE"
            fi
          EOF

      - name: Restore backup
        run: |
          ssh -i ~/.ssh/oracle_key ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'EOF'
            set -e
            BACKUP_FILE="/opt/foundryvtt/backups/data-backup-${{ github.event.inputs.backup_timestamp }}.tar.gz"
            
            echo "ðŸ”„ Restoring backup from ${{ github.event.inputs.backup_timestamp }}..."
            
            # Remove current data
            sudo rm -rf /opt/foundryvtt/data
            
            # Extract backup
            sudo tar -xzf "$BACKUP_FILE" -C /opt/foundryvtt/
            
            # Fix permissions
            sudo chown -R foundryvtt:foundryvtt /opt/foundryvtt/data
            
            echo "âœ… Backup restored successfully"
          EOF

      - name: Start FoundryVTT service
        run: |
          ssh -i ~/.ssh/oracle_key ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'EOF'
            set -e
            echo "â–¶ï¸  Starting FoundryVTT service..."
            sudo systemctl start foundryvtt
            
            echo "â³ Waiting for service to start..."
            sleep 5
            
            if sudo systemctl is-active --quiet foundryvtt; then
              echo "âœ… FoundryVTT service is running!"
            else
              echo "âŒ Service failed to start!"
              echo "ðŸ“‹ Last 30 log lines:"
              sudo journalctl -u foundryvtt -n 30 --no-pager
              exit 1
            fi
          EOF

      - name: Verify rollback
        run: |
          echo "ðŸŽ‰ Rollback complete!"
          echo "ðŸ“ Your FoundryVTT instance: http://${{ secrets.ORACLE_HOST }}:30000"
          echo ""
          echo "âš ï¸  A backup of the data before rollback was created"
          echo "   in case you need to revert this rollback."
